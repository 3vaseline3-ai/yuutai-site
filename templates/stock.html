{% extends "base.html" %}

{% block title %}{{ stock.code }} {{ stock.name }} - 優待クロス管理{% endblock %}

{% block content %}
<h1>{{ stock.code }} {{ stock.name }}</h1>

<h2>一般信用在庫 <span id="zaiko-status" style="font-size: 0.6em; color: #888;">読込中...</span></h2>
<table id="zaiko-table">
    <thead>
        <tr>
            <th>日興</th>
            <th>カブコム</th>
            <th>楽天</th>
            <th>SBI</th>
            <th>GMO</th>
            <th>松井</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td id="zaiko-nikko">-</td>
            <td id="zaiko-kabu">-</td>
            <td id="zaiko-rakuten">-</td>
            <td id="zaiko-sbi">-</td>
            <td id="zaiko-gmo">-</td>
            <td id="zaiko-matsui">-</td>
        </tr>
    </tbody>
</table>

<h2>基本情報</h2>
<table>
    <tr>
        <th>銘柄コード</th>
        <td>{{ stock.code }}</td>
    </tr>
    <tr>
        <th>銘柄名</th>
        <td>{{ stock.name }}</td>
    </tr>
    <tr>
        <th>権利確定月</th>
        <td>{{ stock.settlement_month }}月</td>
    </tr>
    <tr>
        <th>必要株数</th>
        <td>{{ stock.required_shares }}株</td>
    </tr>
    <tr>
        <th>現在株価</th>
        <td>{{ stock.price }}円</td>
    </tr>
    <tr>
        <th>必要資金</th>
        <td>{{ stock.required_amount }}円</td>
    </tr>
</table>

<h2>優待内容</h2>
<table>
    <tr>
        <th>優待内容</th>
        <td>{{ stock.yuutai_content | default('-') }}</td>
    </tr>
    <tr>
        <th>優待価値</th>
        <td>{{ stock.yuutai_value | default('-') }}円</td>
    </tr>
    <tr>
        <th>利回り</th>
        <td>{{ stock.yield | default('-') }}%</td>
    </tr>
</table>

<h2>逆日歩履歴</h2>
<table>
    <thead>
        <tr>
            <th>権利日</th>
            <th>逆日歩</th>
            <th>日数</th>
            <th>合計</th>
        </tr>
    </thead>
    <tbody>
        {% for record in gyaku_hiboku_history %}
        <tr>
            <td>{{ record.date }}</td>
            <td>{{ record.rate }}円</td>
            <td>{{ record.days }}日</td>
            <td>{{ record.total }}円</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="4">履歴データがありません</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>株価チャート</h2>
<div id="price-chart">
    <!-- 株価チャートはここに表示 -->
    <p>チャートデータがありません</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Vercel API エンドポイント
const ZAIKO_API_URL = 'https://yuutai-site.vercel.app/api/zaiko';
const STOCK_CODE = '{{ stock.code }}';

async function fetchZaiko() {
    const statusEl = document.getElementById('zaiko-status');

    try {
        const response = await fetch(`${ZAIKO_API_URL}?code=${STOCK_CODE}`);
        const result = await response.json();

        if (result.error) {
            statusEl.textContent = 'エラー';
            statusEl.style.color = '#dc3545';
            return;
        }

        const data = result.data;

        // 在庫数を表示
        document.getElementById('zaiko-nikko').textContent = formatZaiko(data.nvol);
        document.getElementById('zaiko-kabu').textContent = formatZaiko(data.kvol);
        document.getElementById('zaiko-rakuten').textContent = formatZaiko(data.rvol);
        document.getElementById('zaiko-sbi').textContent = formatZaiko(data.svol);
        document.getElementById('zaiko-gmo').textContent = formatZaiko(data.gvol);
        document.getElementById('zaiko-matsui').textContent = formatZaiko(data.mvol);

        // ステータス更新
        const now = new Date();
        statusEl.textContent = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')} 更新`;
        statusEl.style.color = '#28a745';

    } catch (err) {
        statusEl.textContent = '接続エラー';
        statusEl.style.color = '#dc3545';
        console.error('Zaiko fetch error:', err);
    }
}

function formatZaiko(vol) {
    if (vol === null || vol === undefined || vol === 0 || vol === '0') {
        return '-';
    }
    const num = parseInt(vol);
    if (isNaN(num) || num === 0) return '-';
    return num.toLocaleString() + '株';
}

// ページ読み込み時に実行
document.addEventListener('DOMContentLoaded', fetchZaiko);
</script>
{% endblock %}
